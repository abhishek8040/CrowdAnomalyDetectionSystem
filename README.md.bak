# Crowd Anomaly Detection System

A production-ready end-to-end system for detecting people in CCTV-like video, counting them, tracking them, and detecting various anomalies including overcrowding, zone violations, loitering, and suspicious movements (fight-like anomalies).

![System Architecture](https://img.shields.io/badge/Architecture-Microservices-blue)
![Python](https://img.shields.io/badge/Python-3.10-green)
![React](https://img.shields.io/badge/React-18.2-blue)
![FastAPI](https://img.shields.io/badge/FastAPI-0.104-teal)

## ğŸ¯ Features

### Core Detection Capabilities
- **Person Detection**: YOLOv8-based real-time person detection
- **Multi-Object Tracking**: DeepSORT algorithm for robust tracking across frames
- **Crowd Counting**: Accurate people counting with real-time updates
- **Anomaly Detection**:
  - ğŸ‘¥ **Overcrowding**: Detects when crowd exceeds threshold
  - â±ï¸ **Loitering**: Identifies people staying in one area too long
  - ğŸš« **Zone Violations**: Alerts when restricted areas are entered
  - âš ï¸ **Suspicious Activity**: Detects fight-like movements using pose estimation

### System Features
- Real-time WebSocket streaming for live alerts
- Batch video analysis with detailed reports
- Interactive zone drawing for restricted areas
- Configurable thresholds and parameters
- Event history and replay
- RESTful API with comprehensive documentation
- Docker containerization for easy deployment

## ğŸ“ Project Structure

```
crowd-anomaly-detection-system/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ detector.py          # YOLOv8 person detector
â”‚   â”œâ”€â”€ tracking/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ deepsort.py          # DeepSORT tracker implementation
â”‚   â”œâ”€â”€ anomaly/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ overcrowding.py      # Overcrowding detection
â”‚   â”‚   â”œâ”€â”€ loitering.py         # Loitering detection
â”‚   â”‚   â”œâ”€â”€ zone_violation.py    # Restricted zone monitoring
â”‚   â”‚   â””â”€â”€ suspicious_activity.py # Fight detection via pose
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ video_stream.py      # Video I/O utilities
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ analyze.py           # Video analysis endpoint
â”‚   â”‚   â””â”€â”€ stream.py            # WebSocket streaming
â”‚   â”œâ”€â”€ main.py                  # FastAPI application
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ VideoPlayer.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BoxesOverlay.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ZoneDrawer.jsx
â”‚   â”‚   â”‚   â””â”€â”€ AlertPanel.jsx
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ Dashboard.jsx
â”‚   â”‚   â”‚   â””â”€â”€ Events.jsx
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â””â”€â”€ useWebSocket.js
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â”œâ”€â”€ main.jsx
â”‚   â”‚   â””â”€â”€ index.css
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.js
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ dataset_experiments.ipynb
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ eval_metrics.py
â”œâ”€â”€ Dockerfile.backend
â”œâ”€â”€ Dockerfile.frontend
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

## ğŸš€ Quick Start

### Prerequisites
- Docker & Docker Compose (recommended)
- OR Python 3.10+ and Node.js 18+

### Option 1: Docker (Recommended)

```bash
# Clone the repository
git clone <repository-url>
cd crowd-anomaly-detection-system

# Build and run with Docker Compose
docker-compose up --build

# Access the application
# Frontend: http://localhost:3000
# Backend API: http://localhost:8000
# API Docs: http://localhost:8000/docs
```

### Option 2: Local Development

#### Backend Setup

```bash
cd backend

# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Run the backend server
python main.py
# or
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

#### Frontend Setup

```bash
cd frontend

# Install dependencies
npm install

# Run development server
npm run dev

# Build for production
npm run build
```

## ğŸ“– Usage

### 1. Video Upload & Analysis

1. Navigate to the Dashboard at `http://localhost:3000`
2. Click "Choose video file..." to select a video
3. Configure detection parameters:
   - **Overcrowding Threshold**: Maximum number of people allowed
   - **Loitering Time**: Seconds before flagging loitering
   - **Loitering Distance**: Maximum movement radius (pixels)
   - **Velocity Threshold**: Sensitivity for suspicious movement detection
4. Define restricted zones by clicking "Draw New Zone"
5. Click "Start Analysis" to process the video
6. View results in the Analysis Summary section

### 2. Real-time Monitoring

The system automatically connects to the WebSocket stream and displays:
- Live detection count
- Real-time alerts in the Alert Panel
- Connection status indicator

### 3. Event History

Navigate to the Events page to:
- View all detected anomalies
- Filter by event type
- Review event details and snapshots
- Analyze patterns over time

## ğŸ”§ Configuration

### Backend Configuration

Edit `backend/main.py` or send config via API:

```python
# Default thresholds
OVERCROWDING_THRESHOLD = 10
LOITERING_TIME = 300  # seconds
LOITERING_DISTANCE = 50.0  # pixels
VELOCITY_THRESHOLD = 15.0
```

### API Endpoints

- `POST /api/analyze/upload` - Upload and analyze video
- `GET /api/stream/ws` - WebSocket for real-time streaming
- `GET /health` - Health check
- `GET /config` - Get current configuration
- `POST /config/zones` - Update restricted zones

Full API documentation available at `http://localhost:8000/docs`

## ğŸ“ Datasets

### Recommended Datasets for Training/Testing

1. **UCSD Pedestrian Dataset**
   - Anomaly detection in pedestrian areas
   - http://www.svcl.ucsd.edu/projects/anomaly/dataset.htm

2. **ShanghaiTech Dataset**
   - Crowd counting and density estimation
   - https://github.com/desenzhou/ShanghaiTechDataset

3. **UCF-Crime Dataset**
   - Real-world anomaly detection
   - https://www.crcv.ucf.edu/projects/real-world/

4. **CUHK Avenue Dataset**
   - Abnormal event detection
   - http://www.cse.cuhk.edu.hk/leojia/projects/detectabnormal/dataset.html

5. **MOT Challenge**
   - Multi-object tracking benchmarks
   - https://motchallenge.net/

## ğŸ§  Anomaly Detection Logic

### 1. Overcrowding Detection
```python
# Triggered when person count exceeds threshold
if current_count > threshold:
    alert_overcrowding()
```

### 2. Loitering Detection
```python
# Tracks position history for each person
# Alerts if movement < pixel_threshold for time_threshold seconds
max_displacement = calculate_displacement(track_history)
if max_displacement < pixel_threshold and duration > time_threshold:
    alert_loitering()
```

### 3. Zone Violation
```python
# Uses point-in-polygon algorithm
# Checks if person's center point is inside restricted zone
if point_in_polygon(person_center, restricted_zone):
    alert_zone_violation()
```

### 4. Suspicious Activity (Fight Detection)
```python
# Uses MediaPipe pose estimation
# Analyzes joint velocities for rapid, erratic movements
keypoints = extract_pose(person_bbox)
velocity = calculate_joint_velocity(keypoints_sequence)
if velocity > threshold and is_erratic_pattern(velocity):
    alert_suspicious_activity()
```

## ğŸ“Š Evaluation Metrics

Use the provided evaluation script to measure system performance:

```bash
cd scripts
python eval_metrics.py \
    --predictions predictions.json \
    --ground_truth ground_truth.json \
    --output results.json
```

**Computed Metrics:**
- **Detection**: Precision, Recall, F1-score
- **Counting**: MAE (Mean Absolute Error), MSE, RMSE
- **Anomaly Detection**: Event-level precision, recall, F1

## ğŸ—ï¸ Architecture

### Backend Architecture
```
FastAPI Server
â”œâ”€â”€ Detection Module (YOLOv8)
â”œâ”€â”€ Tracking Module (DeepSORT)
â”œâ”€â”€ Anomaly Detectors
â”‚   â”œâ”€â”€ Overcrowding
â”‚   â”œâ”€â”€ Loitering
â”‚   â”œâ”€â”€ Zone Violation
â”‚   â””â”€â”€ Suspicious Activity
â””â”€â”€ WebSocket Manager
```

### Frontend Architecture
```
React Application
â”œâ”€â”€ Dashboard Page
â”‚   â”œâ”€â”€ Video Upload
â”‚   â”œâ”€â”€ Configuration Panel
â”‚   â”œâ”€â”€ Zone Drawer
â”‚   â””â”€â”€ Stats Display
â”œâ”€â”€ Events Page
â”‚   â”œâ”€â”€ Event List
â”‚   â””â”€â”€ Event Details
â””â”€â”€ WebSocket Hook
```

## ğŸ”¬ Technology Stack

### Backend
- **Framework**: FastAPI
- **Detection**: YOLOv8 (Ultralytics)
- **Tracking**: DeepSORT (FilterPy)
- **Pose**: MediaPipe
- **Computer Vision**: OpenCV
- **Scientific Computing**: NumPy, SciPy
- **Geometry**: Shapely

### Frontend
- **Framework**: React 18
- **Build Tool**: Vite
- **Routing**: React Router
- **HTTP Client**: Axios
- **Charts**: Recharts
- **WebSocket**: Native WebSocket API

### DevOps
- **Containerization**: Docker
- **Orchestration**: Docker Compose
- **API Documentation**: FastAPI Swagger

## ğŸ§ª Testing

### Backend Tests
```bash
cd backend
pytest tests/
```

### Frontend Tests
```bash
cd frontend
npm test
```

## ğŸ› Troubleshooting

### Common Issues

**1. YOLO Model Download**
- First run will download YOLOv8 models (~6MB for yolov8n)
- Ensure internet connection on first startup

**2. WebSocket Connection Failed**
- Check if backend is running on port 8000
- Verify CORS settings in `backend/main.py`

**3. Video Processing Slow**
- Try using smaller YOLOv8 variant (yolov8n)
- Reduce video resolution
- Process fewer frames (skip frames)

**4. High Memory Usage**
- Limit track history length
- Clear old tracks periodically
- Use video streaming instead of loading entire video

## ğŸ¤ Contributing

Contributions are welcome! Please follow these steps:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit your changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

## ğŸ“„ License

This project is licensed under the MIT License - see the LICENSE file for details.

## ğŸ™ Acknowledgments

- **YOLOv8**: Ultralytics for state-of-the-art object detection
- **DeepSORT**: Nicolai Wojke for the tracking algorithm
- **MediaPipe**: Google for pose estimation
- **FastAPI**: SebastiÃ¡n RamÃ­rez for the amazing web framework
- **React**: Meta for the UI library

## ğŸ“§ Contact

For questions, issues, or contributions, please open an issue on GitHub.

## ğŸ—ºï¸ Roadmap

- [ ] Add MongoDB integration for event persistence
- [ ] Implement RTSP stream support
- [ ] Add multi-camera support
- [ ] Enhance UI with 3D visualization
- [ ] Add email/SMS alert notifications
- [ ] Implement advanced analytics dashboard
- [ ] Add model fine-tuning capabilities
- [ ] Support for custom anomaly types
- [ ] Mobile application
- [ ] Cloud deployment guides (AWS, Azure, GCP)

---

**Built with â¤ï¸ for safer and smarter crowd monitoring**
